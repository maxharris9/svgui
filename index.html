<html>
  <head>
    <!-- <script src="https://cdn.jsdelivr.net/npm/preact/dist/preact.min.js"></script> -->
    <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="http://www.jimsproch.com/react/babel-browser.js"></script>
    <script crossorigin type="text/babel" src="./margin.js"></script>
    <script crossorigin type="text/babel" src="./input.js"></script>
    <script crossorigin type="text/babel" src="./button.js"></script>
  </head>
  <body style="margin: 0; padding: 0;">
    <div id="root" />
    <script type="text/babel">
      const Star = (props) => (
        <React.Fragment>
          {props.showLayout && <rect x={0} y={0} width={props.width} height={props.height} stroke={'orange'} fill={'none'} strokeDasharray={'5,5'} />}
          <g transform={`scale(${props.scale}, ${props.scale})`}>
            <polygon points={'90,0 30,188 180,68 0,68 150,188'} fill={'navy'} />
          </g>
        </React.Fragment>
      )

      const Label = (props) => {
        return (
          <React.Fragment>
            {props.showLayout && <rect x={props.x} y={props.y} width={props.width} height={props.height} stroke={'red'} fill={'none'} strokeDasharray={'5,5'} />}
            <text x={props.x} y={props.y + props.height} fill={props.fill} style={{ font: '30px sans-serif' }}>{props.text}</text>
          </React.Fragment>
        )
      }

      // this is a dispatcher that focuses the KeyboardContext onto the input element in focus
      class InputFocuser extends React.Component {
        constructor (props) {
          super(props)

          this.state = {
            focusIndex: 0
          }

          this.handleFocus = this.handleFocus.bind(this)
        }

        componentWillReceiveProps (nextProps) {
          if (nextProps.keystroke.code === 9) {
            const nextFocusedIndex = this.state.focusIndex + 1
            const nextChildrenLength = nextProps.children.length - 1

            if (nextChildrenLength < nextFocusedIndex) {
              this.setState({ focusIndex: 0 })
            } else {
              this.setState({ focusIndex: nextFocusedIndex })
            }
          }
        }

        handleFocus (index) {
          this.setState({ focusIndex: index })
        }

        render () {
          return this.props.children.map((child, index) => {
            if (index === this.state.focusIndex) {
              const props = Object.assign({}, child.props, {
                focused: true,
                keystroke: this.props.keystroke,
                onClick: this.handleFocus,
                index
              })
              return Object.assign({}, child, { props })
            }

            const props = Object.assign({}, child.props, {
              onClick: this.handleFocus,
              index
            })

            return Object.assign({}, child, { props })
          })
        }
      }

      const App = (props) => {
        const star = <Star width={90} height={94} scale={0.5}/>
        return (
          <KeyboardContext.Consumer>
            {
              keystroke => (
                <InputFocuser keystroke={keystroke}>
                  <InputController x={800} y={100} width={1200} height={80} text={'Full Name'} showLayout={props.showLayout} />
                  <InputController x={800} y={200} width={1200} height={80} text={'Address'} showLayout={props.showLayout} />
                  <InputController x={800} y={300} width={1200} height={80} text={'City'} showLayout={props.showLayout} />
                  <InputController x={800} y={400} width={1200} height={80} text={'State'} showLayout={props.showLayout} />
                  <InputController x={800} y={500} width={1200} height={80} text={'ZIP Code'} showLayout={props.showLayout} />
                  <Button x={800} y={600} width={1200} height={80} text={'Sign Up'} fill={'teal'} showLayout={props.showLayout} />
                </InputFocuser>
              )
            }
          </KeyboardContext.Consumer>
        )
      }

      const Demo = (props) => {
        const star = <Star width={90} height={94} scale={0.5}/>
        return (
          <React.Fragment>
            <Button x={100} y={800} width={400} height={380} text={'App'} fill={'teal'} showLayout={props.showLayout} />
            <Input x={600} y={800} width={400} height={100} text={'This is an input element'} showLayout={props.showLayout} />
            <SpacedLine width={props.width} x={0} y={120} showLayout={props.showLayout} >
              <Center><Button width={120} height={120} text={'App'} fill={'red'}/></Center>
              <Center><Button width={120} height={120} text={'B'} fill={'goldenrod'}/></Center>
              <Center>{star}</Center>
              <Center><Button width={200} height={50} text={'Short Button'} fill={'orangered'}/></Center>
              <Center>{star}</Center>
              <Center>{star}</Center>
              <Center>{star}</Center>
              <Center>{star}</Center>
              <Center>{star}</Center>
            </SpacedLine>
            <Margin x={0} y={300} top={30} right={30} bottom={30} left={30} width={props.width} height={150}>
              <Button text={'Button Inside Margin'} fill={'purple'} />
            </Margin>

            <Margin x={0} y={500} top={47} right={100} bottom={47} left={100} width={props.width} height={94}>
              <SpacedLine>
                <Center>{star}</Center>
                <Center>{star}</Center>
                <Center>{star}</Center>
                <Center>{star}</Center>
                <Center>{star}</Center>
                <Center>{star}</Center>
                <Center>{star}</Center>
                <Center>{star}</Center>
              </SpacedLine>
            </Margin>

            {/* when no layout args are supplied, "inherit" from parent */}
            {/* TODO: when missing layout args and not inside layout container, console.error('layout props required - supply layout args or put ${componentName} into a layout container') */}
            {/* TODO: linear flow container that flows components in a text-like manner */}
            {/* TODO: scrolling container */}
          </React.Fragment>
        )
      }

      const Center = (props) => {
        const childWidth = props.children.props.width
        const childHeight = props.children.props.height

        const midX = -childWidth / 2
        const midY = -childHeight / 2

        return <g transform={`translate(${midX}, ${midY})`}>{props.children}</g>
      }

      const SpacedLine = (props) => {
        const slice = props.width / (props.children.length - 1)

        let result = []
        let currentPosition = 0
        for (let i = 0; i < props.children.length; i++) {
          result.push(currentPosition)
          currentPosition += slice
        }
        return (
          <g transform={`translate(${props.x}, ${0})`}>
            {props.showLayout && <line x1={0} y1={props.y} x2={props.width} y2={props.y} stroke={'green'} strokeDasharray={'5,5'} />}
            {
              result.map((pos, index) => {
                const child = props.children[index]
                return <g transform={`translate(${pos}, ${props.y})`} key={index}>{child}</g>
              })
            }
          </g>
        )
      }

      const KeyboardDefault = { code: null, character: null }

      const KeyboardContext = React.createContext(() => {
        console.error('whoops, got default keyboard handler')
        return KeyboardDefault
      })

      // ensures that Tab, Enter, Meta, etc. strings don't make their way into `key`
      const filterKeyCharacter = (key) => {
        if (key.length > 1) { return '' }
        return key
      }

      class Root extends React.Component {
        constructor (props) {
          super(props)

          this.state = {
            width: this.getWindowWidth(),
            height: this.getWindowHeight(),
            keystroke: KeyboardDefault
          }
          this.handleKeystroke = this.handleKeystroke.bind(this)
        }

        getWindowWidth () { return window.innerWidth * 2 }
        getWindowHeight () { return window.innerHeight * 2 }

        componentDidMount () {
          const onResize = (e) => {
            const height = this.getWindowHeight()
            const width = this.getWindowWidth()

            this.setState({ width, height })
          }
          window.addEventListener('resize', onResize)
          window.addEventListener('keydown', this.handleKeystroke)
        }

        handleKeystroke (event) {
          if (event.keyCode === 9) { // tab
            event.preventDefault()
          }

          if (event && event.key) {
            this.setState({ keystroke: { code: event.keyCode, character: filterKeyCharacter(event.key) } })
          }
        }

        render () {
          return (
            <KeyboardContext.Provider value={this.state.keystroke}>
              <svg viewBox={[0, 0, this.state.width, this.state.height]}>
                <rect x={0} y={0} width={this.state.width} height={this.state.height} fill={'cornsilk'} stroke={'red'} strokeWidth={2} strokeDasharray={'5,5'}/>
                <App width={this.state.width} height={this.state.height} showLayout />
              </svg>
            </KeyboardContext.Provider>
          )
        }
      }

      const measureTextWidth = ({ text, fontWeight, fontStyle, fontSize, fontFamily }) => {
        const canvas = document.createElement('canvas')
        const ctx = canvas.getContext('2d')
        ctx.font = `${fontWeight} ${fontStyle} ${fontSize} ${fontFamily}`
        return ctx.measureText(text).width
      }

      ReactDOM.render(<Root />, document.getElementById('root'))
    </script>
  </body>
</html>
